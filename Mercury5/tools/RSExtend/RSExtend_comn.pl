#!/usr/bin/perl

chdir "../../proj";
system ("make PartialMake  RELEASE_PROCESS=0 GEN_PREPROCESS=1 L1=mmicomn");

my $product;
open(CONF, "<config.mak");
while(<CONF>)
{
	$product = $1 if($_ =~ /PRODUCT=(.+)/);	
}
close(CONF);

my $src_dir = "build/"."$product"."/out/";
my $des_dir = "sc/application/mmi/common/inc";
my $product_src = "config.mak";
my %hash;
my $comment = "/**\n* \@file rs_gen_struct.h\n*\n* This header file defines the RS strcutures\n*\n* which is generated by \"tools/RSExtend/RSExtend.pl\"\n* \n* \n**/\n\n";

open(CMD, "find $src_dir -name \"*o.pp\"|");
while (<CMD>)
{
	chomp;
	push @file, $_;
}
close(CMD);

open(CONTENT,">$des_dir"."/rs_gen_struct.h");
print CONTENT $comment;
foreach $file(@file)
{
	$title = $2 if($file =~ /\/(.+)\/(.+)\.o\.pp/);
	
	open(FILE, "<$file");
	$flag = 0;
	$if_print = 0;
	$if_start = 0;
	$if_end = 0;
	while($content=<FILE>)
	{

		if($flag == 0 && $content =~ /RS_STRUCT_START/)
		{
			$flag = 1;
			$if_print = 1;
			$if_start = 1;	
			$if_end =1;				
		}
		elsif($flag == 1 && $content =~ /RS_STRUCT_END/)
		{
			$flag = 0;
			print CONTENT "/***** "."$title"."_END *****/\n\n" if($if_end == 1);
		}
		elsif($flag == 1)
		{
			next if($content =~ /#line/ || $content =~ /^\s*$/);
			if($if_start == 1 && $hash{$content} =~ /$content/)
			{
				$if_print = 0;				
				$if_end = 0;
			}
			elsif($if_start == 1)
			{
				$hash{$content} = "$content";
				print CONTENT "\n/***** " ."$title"."_START *****/\n";	
			}
			if($if_print == 1)
			{
				print CONTENT "$content";
			}
			$if_start = 0;
		}
	}
	close(FILE);
}
close(CONTENT);
